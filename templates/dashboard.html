{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h4 mb-0 text-white fw-bold">Dashboard</h1>
            <p class="text-muted small mb-0">Estatísticas em tempo real</p>
        </div>
        <div class="d-flex gap-2">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-light dropdown-toggle border-0 bg-transparent" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-1"></i>Exportar
                </button>
                <ul class="dropdown-menu dropdown-menu-dark shadow border-0 small">
                    <li><a class="dropdown-item py-1" href="{{ url_for('generate_filtered_pdf', search=current_search, status_filter=current_status_filter, priority_filter=current_priority_filter, impact_filter=current_impact_filter, classe_filter=current_classe_filter, categoria_filter=current_categoria_filter, responsible_filter=current_responsible_filter, date_from=current_date_from, date_to=current_date_to) }}">
                        <i class="fas fa-file-pdf me-2 text-danger"></i>PDF
                    </a></li>
                    <li><a class="dropdown-item py-1" href="{{ url_for('export_excel_filtered', search=current_search, status_filter=current_status_filter, priority_filter=current_priority_filter, impact_filter=current_impact_filter, classe_filter=current_classe_filter, categoria_filter=current_categoria_filter, responsible_filter=current_responsible_filter, date_from=current_date_from, date_to=current_date_to) }}">
                        <i class="fas fa-file-excel me-2 text-success"></i>Excel
                    </a></li>
                </ul>
            </div>
            <a href="{{ url_for('new_request') }}" class="btn btn-sm btn-primary px-3 shadow-sm">
                <i class="fas fa-plus me-1"></i>Novo Pedido
            </a>
        </div>
    </div>

    <!-- Main KPIs -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 bg-dark-subtle h-100 shadow-sm transition-hover">
                <div class="card-body d-flex align-items-center p-3">
                    <div class="rounded-circle p-2 bg-primary bg-opacity-10 me-3">
                        <i class="fas fa-layer-group fa-lg text-primary"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase mb-0 small fw-semibold" style="font-size: 0.7rem;">Total de Pedidos</h6>
                        <h4 class="mb-0 text-white fw-bold">{{ total_requests }}</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-dark-subtle h-100 shadow-sm transition-hover">
                <div class="card-body d-flex align-items-center p-3">
                    <div class="rounded-circle p-2 bg-success bg-opacity-10 me-3">
                        <i class="fas fa-file-invoice-dollar fa-lg text-success"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase mb-0 small fw-semibold" style="font-size: 0.7rem;">Valor Estimado</h6>
                        <h4 class="mb-0 text-white fw-bold">R$ {{ "{:,.2f}".format(total_estimated).replace(',', 'X').replace('.', ',').replace('X', '.') }}</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-dark-subtle h-100 shadow-sm transition-hover">
                <div class="card-body d-flex align-items-center p-3">
                    <div class="rounded-circle p-2 bg-warning bg-opacity-10 me-3">
                        <i class="fas fa-check-double fa-lg text-warning"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase mb-0 small fw-semibold" style="font-size: 0.7rem;">Valor Final</h6>
                        <h4 class="mb-0 text-white fw-bold">R$ {{ "{:,.2f}".format(total_final).replace(',', 'X').replace('.', ',').replace('X', '.') }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Class Breakdown (Financial Focus) -->
    <div class="mb-3 d-flex align-items-center">
        <h6 class="mb-0 text-white me-3 small text-uppercase fw-bold opacity-75">Investimento por Classe</h6>
        <div class="flex-grow-1 border-bottom border-secondary opacity-25"></div>
    </div>
    
    <div class="row g-3 mb-4">
        {% set classe_colors = {
            'Ensino': '#7b61ff',
            'Manutenção': '#00d1ff',
            'Administrativo': '#ffc107'
        } %}
        {% for classe_name, stats in classe_stats.items() %}
        <div class="col-md-4">
            <div class="card border-0 bg-transparent h-100 p-0">
                <div class="card-body p-0 d-flex flex-column align-items-center">
                    <div class="mb-2" style="color: {{ classe_colors.get(classe_name, '#7b61ff') }};">
                        <i class="fas fa-circle-nodes fa-2x"></i>
                    </div>
                    <h6 class="text-white mb-1 fw-medium small">{{ classe_name }}</h6>
                    <h4 class="fw-bold mb-1" style="color: {{ classe_colors.get(classe_name, '#7b61ff') }};">
                        R$ {{ "{:,.2f}".format(stats.total_value).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                    </h4>
                    <span class="badge rounded-pill bg-secondary bg-opacity-25 text-muted px-2 py-1" style="font-size: 0.65rem;">
                        {{ stats.count }} pedidos
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Status Toggles (Clean Horizontal Bar) -->
    <div class="mb-4">
        <div class="card border-0 bg-dark-subtle p-1 shadow-sm">
            <div class="card-body p-0 d-flex overflow-auto gap-1 scroll-hide">
                {% for status_name, count in status_counts.items() %}
                <div class="flex-fill text-center p-2 rounded transition-hover" style="min-width: 90px;">
                    <div class="text-info fw-bold h6 mb-0">{{ count }}</div>
                    <div class="text-muted fw-bold" style="font-size: 0.6rem; text-transform: uppercase; white-space: nowrap;">{{ status_name }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Filters & Table Section -->
    <div class="row g-4">
        <!-- Compact Filters -->
        <div class="col-lg-12">
            <div class="card border-0 bg-dark-subtle shadow-sm mb-3">
                <div class="card-body p-3">
                    <form method="GET" class="row g-2 align-items-end">
                        <div class="col-6 col-md-3">
                            <label class="form-label text-muted mb-1" style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase;">Busca</label>
                            {{ search_form.search(class="form-control form-control-sm bg-dark border-0 text-white", placeholder="Título...") }}
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label text-muted mb-1" style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase;">Status</label>
                            {{ search_form.status_filter(class="form-select form-select-sm bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label text-muted mb-1" style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase;">Prioridade</label>
                            {{ search_form.priority_filter(class="form-select form-select-sm bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label text-muted mb-1" style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase;">Impacto</label>
                            {{ search_form.impact_filter(class="form-select form-select-sm bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label text-muted mb-1" style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase;">Responsável</label>
                            {{ search_form.responsible_filter(class="form-select form-select-sm bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label text-muted mb-1" style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase;">Classe</label>
                            {{ search_form.classe_filter(class="form-select form-select-sm bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label text-muted mb-1" style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase;">Categoria</label>
                            {{ search_form.categoria_filter(class="form-select form-select-sm bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label text-muted mb-1" style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase;">De</label>
                            {{ search_form.date_from(class="form-control form-control-sm bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label text-muted mb-1" style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase;">Até</label>
                            {{ search_form.date_to(class="form-control form-control-sm bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-12 col-md-2 d-flex gap-1">
                            <button type="submit" class="btn btn-sm btn-primary w-100">Filtrar</button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-dark w-100">Limpar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Clean Requests Table -->
        <div class="col-lg-12">
            <div class="card border-0 bg-dark-subtle shadow-sm overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle mb-0">
                        <thead class="bg-dark bg-opacity-50">
                            <tr>
                                <th class="border-0 px-3 py-2 text-muted small fw-bold" style="font-size: 0.7rem;">ID</th>
                                <th class="border-0 px-3 py-2 text-muted small fw-bold" style="font-size: 0.7rem;">Pedido</th>
                                <th class="border-0 px-3 py-2 text-muted small fw-bold" style="font-size: 0.7rem;">Status</th>
                                <th class="border-0 px-3 py-2 text-muted small fw-bold" style="font-size: 0.7rem;">Classe</th>
                                <th class="border-0 px-3 py-2 text-muted small fw-bold" style="font-size: 0.7rem;">Valor Estimado</th>
                                <th class="border-0 px-3 py-2 text-muted small fw-bold text-center" style="font-size: 0.7rem;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in requests %}
                            <tr>
                                <td class="px-3 py-2 text-muted small">#{{ request.id }}</td>
                                <td class="px-3 py-2">
                                    <div class="fw-bold text-white small">{{ request.title }}</div>
                                    <div class="small text-muted" style="font-size: 0.65rem;">{{ request.request_date.strftime('%d/%m/%Y') }}</div>
                                </td>
                                <td class="px-3 py-2">
                                    {% set status_colors = {
                                        'aberto': 'info',
                                        'em_cotacao': 'warning',
                                        'aprovado': 'primary',
                                        'pedido_emitido': 'success',
                                        'recebido': 'light',
                                        'cancelado': 'danger'
                                    } %}
                                    <span class="badge bg-{{ status_colors.get(request.status, 'secondary') }} bg-opacity-10 text-{{ status_colors.get(request.status, 'secondary') }} rounded-pill px-2 py-1" style="font-size: 0.65rem;">
                                        {{ request.get_status_display() }}
                                    </span>
                                </td>
                                <td class="px-3 py-2">
                                    <span class="text-white-50 small" style="font-size: 0.75rem;">{{ request.get_classe_display() }}</span>
                                </td>
                                <td class="px-3 py-2 fw-bold text-success small">
                                    R$ {{ "{:,.2f}".format(request.estimated_value or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                </td>
                                <td class="px-3 py-2 text-center">
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('view_request', id=request.id) }}" class="btn btn-outline-light border-0 opacity-75 hover-opacity-100 p-1">
                                            <i class="fas fa-eye fa-sm"></i>
                                        </a>
                                        <a href="{{ url_for('edit_request', id=request.id) }}" class="btn btn-outline-light border-0 opacity-75 hover-opacity-100 p-1">
                                            <i class="fas fa-edit fa-sm"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Minimalist Pagination -->
            {% if pagination.pages > 1 %}
            <div class="mt-4 d-flex justify-content-center">
                {{ pagination.links }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .bg-dark-subtle { background-color: #1a1d21 !important; }
    .transition-hover { transition: transform 0.2s ease, background-color 0.2s ease; }
    .transition-hover:hover { transform: translateY(-3px); background-color: #212529 !important; }
    .scroll-hide::-webkit-scrollbar { display: none; }
    .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .hover-opacity-100:hover { opacity: 1 !important; }
    .table-hover tbody tr:hover { background-color: rgba(255,255,255,0.02); }
</style>
{% endblock %}
