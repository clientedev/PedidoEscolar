{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="h3 mb-0 text-white fw-bold">Dashboard de Aquisições</h1>
            <p class="text-muted small mb-0">Visão geral do sistema e estatísticas em tempo real</p>
        </div>
        <div class="d-flex gap-2">
            <div class="dropdown">
                <button class="btn btn-outline-light dropdown-toggle border-0 bg-transparent" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-2"></i>Exportar
                </button>
                <ul class="dropdown-menu dropdown-menu-dark shadow border-0">
                    <li><a class="dropdown-item" href="{{ url_for('generate_filtered_pdf', search=current_search, status_filter=current_status_filter, priority_filter=current_priority_filter, impact_filter=current_impact_filter, classe_filter=current_classe_filter, categoria_filter=current_categoria_filter, responsible_filter=current_responsible_filter, date_from=current_date_from, date_to=current_date_to) }}">
                        <i class="fas fa-file-pdf me-2 text-danger"></i>PDF
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('export_excel_filtered', search=current_search, status_filter=current_status_filter, priority_filter=current_priority_filter, impact_filter=current_impact_filter, classe_filter=current_classe_filter, categoria_filter=current_categoria_filter, responsible_filter=current_responsible_filter, date_from=current_date_from, date_to=current_date_to) }}">
                        <i class="fas fa-file-excel me-2 text-success"></i>Excel
                    </a></li>
                </ul>
            </div>
            <a href="{{ url_for('new_request') }}" class="btn btn-primary px-4 shadow-sm">
                <i class="fas fa-plus me-2"></i>Novo Pedido
            </a>
        </div>
    </div>

    <!-- Main KPIs -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card border-0 bg-dark-subtle h-100 shadow-sm transition-hover">
                <div class="card-body d-flex align-items-center p-4">
                    <div class="rounded-circle p-3 bg-primary bg-opacity-10 me-4">
                        <i class="fas fa-layer-group fa-2x text-primary"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase mb-1 small fw-semibold">Total de Pedidos</h6>
                        <h2 class="mb-0 text-white fw-bold">{{ total_requests }}</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-dark-subtle h-100 shadow-sm transition-hover">
                <div class="card-body d-flex align-items-center p-4">
                    <div class="rounded-circle p-3 bg-success bg-opacity-10 me-4">
                        <i class="fas fa-file-invoice-dollar fa-2x text-success"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase mb-1 small fw-semibold">Valor Estimado</h6>
                        <h2 class="mb-0 text-white fw-bold">R$ {{ "{:,.2f}".format(total_estimated).replace(',', 'X').replace('.', ',').replace('X', '.') }}</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-dark-subtle h-100 shadow-sm transition-hover">
                <div class="card-body d-flex align-items-center p-4">
                    <div class="rounded-circle p-3 bg-warning bg-opacity-10 me-4">
                        <i class="fas fa-check-double fa-2x text-warning"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase mb-1 small fw-semibold">Valor Final</h6>
                        <h2 class="mb-0 text-white fw-bold">R$ {{ "{:,.2f}".format(total_final).replace(',', 'X').replace('.', ',').replace('X', '.') }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Class Breakdown (Financial Focus) -->
    <div class="mb-4 d-flex align-items-center">
        <h5 class="mb-0 text-white me-3">Investimento por Classe</h5>
        <div class="flex-grow-1 border-bottom border-secondary opacity-25"></div>
    </div>
    
    <div class="row g-4 mb-5">
        {% set classe_colors = {
            'Ensino': '#7b61ff',
            'Manutenção': '#00d1ff',
            'Administrativo': '#ffc107'
        } %}
        {% for classe_name, stats in classe_stats.items() %}
        <div class="col-md-4">
            <div class="card border-0 bg-transparent h-100 p-0">
                <div class="card-body p-0 d-flex flex-column align-items-center">
                    <div class="mb-3" style="color: {{ classe_colors.get(classe_name, '#7b61ff') }};">
                        <i class="fas fa-circle-nodes fa-3x"></i>
                    </div>
                    <h6 class="text-white mb-2 fw-medium">{{ classe_name }}</h6>
                    <h3 class="fw-bold" style="color: {{ classe_colors.get(classe_name, '#7b61ff') }};">
                        R$ {{ "{:,.2f}".format(stats.total_value).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                    </h3>
                    <span class="badge rounded-pill bg-secondary bg-opacity-25 text-muted px-3 py-2 small">
                        {{ stats.count }} pedidos
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Status Toggles (Clean Horizontal Bar) -->
    <div class="mb-5">
        <div class="card border-0 bg-dark-subtle p-2">
            <div class="card-body p-0 d-flex overflow-auto gap-2 scroll-hide">
                {% for status_name, count in status_counts.items() %}
                <div class="flex-fill text-center p-3 rounded transition-hover" style="min-width: 140px;">
                    <div class="text-info fw-bold h4 mb-0">{{ count }}</div>
                    <div class="text-muted small text-uppercase fw-semibold">{{ status_name }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Filters & Table Section -->
    <div class="row g-4">
        <!-- Compact Filters -->
        <div class="col-lg-12">
            <div class="card border-0 bg-dark-subtle shadow-sm mb-4">
                <div class="card-body p-4">
                    <form method="GET" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label text-muted small fw-bold">Busca</label>
                            {{ search_form.search(class="form-control bg-dark border-0 text-white", placeholder="Título ou descrição...") }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-muted small fw-bold">Status</label>
                            {{ search_form.status_filter(class="form-select bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-muted small fw-bold">Prioridade</label>
                            {{ search_form.priority_filter(class="form-select bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted small fw-bold">Responsável</label>
                            {{ search_form.responsible_filter(class="form-select bg-dark border-0 text-white") }}
                        </div>
                        <div class="col-md-2 d-flex gap-2">
                            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-dark w-100">Limpar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Clean Requests Table -->
        <div class="col-lg-12">
            <div class="card border-0 bg-dark-subtle shadow-sm overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle mb-0">
                        <thead class="bg-dark bg-opacity-50">
                            <tr>
                                <th class="border-0 px-4 py-3 text-muted small fw-bold">ID</th>
                                <th class="border-0 px-4 py-3 text-muted small fw-bold">Pedido</th>
                                <th class="border-0 px-4 py-3 text-muted small fw-bold">Status</th>
                                <th class="border-0 px-4 py-3 text-muted small fw-bold">Classe</th>
                                <th class="border-0 px-4 py-3 text-muted small fw-bold">Valor Estimado</th>
                                <th class="border-0 px-4 py-3 text-muted small fw-bold text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in requests %}
                            <tr>
                                <td class="px-4 py-3 text-muted">#{{ request.id }}</td>
                                <td class="px-4 py-3">
                                    <div class="fw-bold text-white">{{ request.title }}</div>
                                    <div class="small text-muted">{{ request.request_date.strftime('%d/%m/%Y') }}</div>
                                </td>
                                <td class="px-4 py-3">
                                    {% set status_colors = {
                                        'aberto': 'info',
                                        'em_cotacao': 'warning',
                                        'aprovado': 'primary',
                                        'pedido_emitido': 'success',
                                        'recebido': 'light',
                                        'cancelado': 'danger'
                                    } %}
                                    <span class="badge bg-{{ status_colors.get(request.status, 'secondary') }} bg-opacity-10 text-{{ status_colors.get(request.status, 'secondary') }} rounded-pill px-3">
                                        {{ request.get_status_display() }}
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="text-white-50 small">{{ request.get_classe_display() }}</span>
                                </td>
                                <td class="px-4 py-3 fw-bold text-success">
                                    R$ {{ "{:,.2f}".format(request.estimated_value or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('view_request', id=request.id) }}" class="btn btn-outline-light border-0 opacity-75 hover-opacity-100">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('edit_request', id=request.id) }}" class="btn btn-outline-light border-0 opacity-75 hover-opacity-100">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Minimalist Pagination -->
            {% if pagination.pages > 1 %}
            <div class="mt-4 d-flex justify-content-center">
                {{ pagination.links }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .bg-dark-subtle { background-color: #1a1d21 !important; }
    .transition-hover { transition: transform 0.2s ease, background-color 0.2s ease; }
    .transition-hover:hover { transform: translateY(-3px); background-color: #212529 !important; }
    .scroll-hide::-webkit-scrollbar { display: none; }
    .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .hover-opacity-100:hover { opacity: 1 !important; }
    .table-hover tbody tr:hover { background-color: rgba(255,255,255,0.02); }
</style>
{% endblock %}
