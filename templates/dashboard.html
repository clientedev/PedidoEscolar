{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block content %}
<div class="row align-items-center mb-4 g-3">
    <div class="col-12 col-md">
        <h1 class="h3 mb-0 text-white"><i class="fas fa-tachometer-alt me-2 text-primary"></i>Dashboard</h1>
    </div>
    <div class="col-12 col-md-auto d-flex gap-2 flex-wrap">
        <a href="{{ url_for('new_request') }}" class="btn btn-primary flex-fill px-3">
            <i class="fas fa-plus me-1"></i>Novo
        </a>
        <div class="dropdown flex-fill">
            <button class="btn btn-outline-light w-100 dropdown-toggle" type="button" data-bs-toggle="dropdown">Relatórios</button>
            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                <li><a class="dropdown-item" href="{{ url_for('generate_filtered_pdf') }}"><i class="fas fa-file-pdf me-2 text-danger"></i>PDF</a></li>
                <li><a class="dropdown-item" href="{{ url_for('export_excel_filtered') }}"><i class="fas fa-file-excel me-2 text-success"></i>Excel</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="row row-cols-1 row-cols-sm-3 g-2 mb-4">
    <div class="col">
        <div class="card border-0 bg-dark text-white p-2">
            <small class="text-muted opacity-75">Total de Pedidos</small>
            <h4 class="mb-0">{{ total_requests }}</h4>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 bg-dark text-white p-2">
            <small class="text-muted opacity-75">Estimado Total</small>
            <h5 class="mb-0 text-success">R${{ "%.2f"|format(total_estimated) }}</h5>
        </div>
    </div>
    <div class="col">
        <div class="card border-0 bg-dark text-white p-2">
            <small class="text-muted opacity-75">Finalizado Total</small>
            <h5 class="mb-0 text-warning">R${{ "%.2f"|format(total_final) }}</h5>
        </div>
    </div>
</div>

<div class="card mb-4 border-0 bg-dark p-2">
    <form method="GET" class="row g-2">
        <div class="col-12 col-md-6">{{ search_form.search(class="form-control bg-secondary text-white border-0", placeholder="Buscar...") }}</div>
        <div class="col-6 col-md-3">{{ search_form.status_filter(class="form-select bg-secondary text-white border-0") }}</div>
        <div class="col-6 col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill"><i class="fas fa-search"></i></button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary"><i class="fas fa-times"></i></a>
        </div>
    </form>
</div>

<div class="card border-0 bg-dark overflow-hidden">
    <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
            <thead>
                <tr class="text-muted small">
                    <th class="ps-3">ID</th>
                    <th>Pedido / Status</th>
                    <th class="text-end pe-3">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for request in requests %}
                <tr>
                    <td class="ps-3 text-muted">#{{ request.id }}</td>
                    <td>
                        <div class="fw-bold"><a href="{{ url_for('view_request', id=request.id) }}" class="text-white text-decoration-none">{{ request.title }}</a></div>
                        <div class="small mt-1 d-flex flex-wrap gap-1">
                            <span class="badge bg-primary bg-opacity-25 text-primary x-small">{{ request.get_status_display() }}</span>
                            <span class="text-muted x-small opacity-50">{{ request.request_date.strftime('%d/%m/%Y') }}</span>
                        </div>
                    </td>
                    <td class="text-end pe-3">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary border-0" type="button" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-h"></i></button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0 bg-dark text-white">
                                <li><a class="dropdown-item text-white" href="{{ url_for('view_request', id=request.id) }}"><i class="fas fa-eye me-2"></i>Ver</a></li>
                                <li><a class="dropdown-item text-white" href="{{ url_for('edit_request', id=request.id) }}"><i class="fas fa-edit me-2"></i>Editar</a></li>
                                <li><hr class="dropdown-divider bg-secondary"></li>
                                <li>
                                    <form method="POST" action="{{ url_for('delete_request', id=request.id) }}" onsubmit="return confirm('Excluir?')">
                                        <button type="submit" class="dropdown-item text-danger"><i class="fas fa-trash me-2"></i>Excluir</button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .x-small { font-size: 0.65rem; }
    .table-dark { --bs-table-bg: #1e1e1e; }
    .btn-primary { background-color: #0d6efd; border: none; }
    .card.bg-dark { background-color: #1e1e1e !important; }
</style>
{% endblock %}